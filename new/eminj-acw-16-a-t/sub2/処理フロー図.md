# 処理フロー図

## 全体システムフロー

```
┌─────────────────────────────────────────────────────────────┐
│                    エンジン制御システム                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────┐
        │       eminj_l_mat.c モジュール       │
        │    (噴射要求の調停と管理)             │
        └─────────────────────────────────────┘
                    │         │         │
        ┌───────────┴─────┬───┴────┬────────┐
        │                 │        │        │
        ▼                 ▼        ▼        ▼
   初期化処理        調停処理   データ   データ
   (pwon時)         (8msm時)   取得I/F  取得I/F
                                (旧)     (新)
```

## 初期化処理フロー (vdg_eminj_pwon)

```
┌─────────────────────────────────────────┐
│        vdg_eminj_pwon() 開始            │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 1. シリンダ数・バンク数の取得           │
│    - u1g_ejcc_NCYL                      │
│    - u1g_ejcc_NOX                       │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 2. 噴射量補正係数の初期化               │
│    - s2_ekrchref[NOX] = KRICHI          │
│    - f4_ekrchref[NOX] = 変換後の値      │
│    - s2g_eminj_ekrichx = KRICHI         │
│    - f4g_eminj_ekrichx = 変換後の値     │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 3. ポート噴射係数の設定                 │
│    JEEFI == PORT ?                      │
│      YES: kpfi = 1.0                    │
│      NO:  kpfi = 0.0                    │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 4. 噴射終了時刻の取得 (D4以外)          │
│    - vdg_ebinjctr_ebinjctr_dataget()   │
│    - stt_injdat.s2_einjend 設定         │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 5. 可変燃圧要求の初期化 (PRDEMAND時)    │
│    - s2g_eminj_eprreql 設定             │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 6. データ構造への反映                   │
│    - vds_eminj_einj_dataset()           │
│    - vds_eminj_eminj_dataset()          │
│    (旧構造と新構造の両方)               │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│           処理完了・終了                │
└─────────────────────────────────────────┘
```

## メイン調停処理フロー (vdg_eminj_8msm)

```
┌─────────────────────────────────────────┐
│       vdg_eminj_8msm() 開始             │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 1. 前提条件チェック                     │
│    - NE同期タスク完了フラグ確認         │
│    - 噴射メディ無効フラグ確認           │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 2. 基本パラメータ取得                   │
│    - シリンダ数、バンク数               │
│    - 噴射段数                           │
│    - 排気状態フラグ                     │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 3. 補正係数の算出                       │
│    ┌─────────────────────────────────┐ │
│    │ バンク別噴射量補正係数           │ │
│    │ - eclrfld データ取得             │ │
│    │ - s2t_krichxbcrt[NOX] 算出       │ │
│    └─────────────────────────────────┘ │
│    ┌─────────────────────────────────┐ │
│    │ 総合補正係数                     │ │
│    │ - s2t_krichx 算出                │ │
│    └─────────────────────────────────┘ │
│    ┌─────────────────────────────────┐ │
│    │ ポート噴射係数                   │ │
│    │ - k1f, k2f, k3f 算出             │ │
│    │ - kpfi_wk, kpfin[NOX] 算出       │ │
│    └─────────────────────────────────┘ │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 4. DUAL/D4モード時の追加処理            │
│    - 最大直噴量係数取得                 │
│    - 噴射モード取得                     │
│    - 直噴追加噴射開始角度               │
│    - 基本直噴噴射開始角度               │
│    - 直噴噴射禁止範囲角度               │
│    - 高圧側目標燃圧                     │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 5. 各機能からの要求データ取得           │
│    (優先度テーブル順にループ処理)       │
│    ┌─────────────────────────────────┐ │
│    │ for (u1t_num = 0;                │ │
│    │      u1t_num < u1s_EMINJ_NUM;    │ │
│    │      u1t_num++)                  │ │
│    │ {                                │ │
│    │   // 要求データ取得関数呼び出し  │ │
│    │   sts_eminj_eminj_tbl[u1t_num]   │ │
│    │     .pff_rap_dataget()           │ │
│    │ }                                │ │
│    └─────────────────────────────────┘ │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 6. 優先度による調停処理                 │
│    ┌─────────────────────────────────┐ │
│    │ 通常調停                         │ │
│    │ vds_eminj_eminj_hpri()           │ │
│    │ - 優先度テーブルに基づく比較     │ │
│    │ - 最高優先度要求の選択           │ │
│    └─────────────────────────────────┘ │
│    ┌─────────────────────────────────┐ │
│    │ 制限考慮調停                     │ │
│    │ vds_eminj_eminjlmt_hpri()        │ │
│    │ - 制限フラグを考慮した判定       │ │
│    └─────────────────────────────────┘ │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 7. 噴射パラメータの決定と適用           │
│    - 選択された要求の噴射量             │
│    - 選択された要求の噴射時期           │
│    - 補正係数の適用                     │
│    - 各種制限の適用                     │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 8. データ構造への格納                   │
│    - stg_eminj_einj (旧構造)            │
│    - stg_eminj_eminj (新構造)           │
│    - vds_eminj_einj_dataset()           │
│    - vds_eminj_eminj_dataset()          │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 9. 外部モジュールへの通知               │
│    - vdg_ainjif_renew_injrq()           │
│    (噴射要求更新通知)                   │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│           処理完了・終了                │
└─────────────────────────────────────────┘
```

## 優先度判定処理フロー

```
┌─────────────────────────────────────────┐
│   vds_eminj_eminj_hpri() / 通常調停     │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 1. 入力パラメータ確認                   │
│    - ptt_datsel: 選択結果格納先         │
│    - ptt_data[]: 要求データ配列         │
│    - u1t_num: 要求数                    │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 2. 初期化                               │
│    - 最高優先度を最低値に設定           │
│    - 選択インデックスを0に設定          │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 3. 優先度比較ループ                     │
│    for (i = 0; i < u1t_num; i++)        │
│    {                                    │
│      if (ptt_data[i].u1_epri >          │
│          最高優先度)                     │
│      {                                  │
│        // 優先度が高ければ更新          │
│        最高優先度 = ptt_data[i].u1_epri │
│        選択インデックス = i             │
│      }                                  │
│    }                                    │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 4. 選択結果の格納                       │
│    *ptt_datsel =                        │
│      ptt_data[選択インデックス]         │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│           処理完了・リターン            │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ vds_eminj_eminjlmt_hpri() / 制限調停    │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 1. 入力パラメータ確認                   │
│    - ptt_datsel: 選択結果格納先         │
│    - ptt_data[]: 要求データ配列         │
│    - u1t_num: 要求数                    │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 2. 初期化                               │
│    - 最高優先度を最低値に設定           │
│    - 選択インデックスを0に設定          │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 3. 制限考慮優先度比較ループ             │
│    for (i = 0; i < u1t_num; i++)        │
│    {                                    │
│      // 制限フラグをチェック            │
│      if (制限なし OR                     │
│          制限条件を満たす)               │
│      {                                  │
│        if (ptt_data[i].u1_epri >        │
│            最高優先度)                   │
│        {                                │
│          最高優先度 =                   │
│            ptt_data[i].u1_epri          │
│          選択インデックス = i           │
│        }                                │
│      }                                  │
│    }                                    │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 4. 選択結果の格納                       │
│    *ptt_datsel =                        │
│      ptt_data[選択インデックス]         │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│           処理完了・リターン            │
└─────────────────────────────────────────┘
```

## データ取得インターフェースフロー

```
┌─────────────────────────────────────────┐
│    vdg_eminj_einj_dataget() 開始        │
│    (旧構造用データ取得)                 │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 1. 排他制御開始                         │
│    glint_di() - 割り込み禁止            │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 2. データコピー                         │
│    for (全シリンダ)                     │
│    {                                    │
│      for (全バンク)                     │
│      {                                  │
│        ptt_retval->データ =             │
│          stg_eminj_einj.データ          │
│      }                                  │
│    }                                    │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 3. 排他制御終了                         │
│    glint_ei() - 割り込み許可            │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│           処理完了・リターン            │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│   vdg_eminj_eminj_dataget() 開始        │
│   (新構造用データ取得)                  │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 1. 排他制御開始                         │
│    glint_di() - 割り込み禁止            │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 2. データコピー (拡張版)                │
│    for (全シリンダ)                     │
│    {                                    │
│      for (全バンク)                     │
│      {                                  │
│        for (全噴射段)                   │
│        {                                │
│          ptt_retval->データ =           │
│            stg_eminj_eminj.データ       │
│        }                                │
│      }                                  │
│    }                                    │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│ 3. 排他制御終了                         │
│    glint_ei() - 割り込み許可            │
└─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│           処理完了・リターン            │
└─────────────────────────────────────────┘
```

## データフロー図

```
┌──────────────────────────────────────────────────┐
│               外部機能モジュール                  │
│  ・erestahot (高温始動)                          │
│  ・erdpn (電動ポンプ)                            │
│  ・estahv (HV始動)                               │
│  ・estpss (SS停止)                               │
│  ・estass (SS始動)                               │
│  ・eactgaf (GAF有効化)                           │
│  ・eclrdepi (デポジットクリーン)                 │
│  ・その他多数...                                 │
└──────────────────────────────────────────────────┘
                       │
                       │ vdg_*_emedi_dataget()
                       │ (各機能の噴射要求データ)
                       ▼
┌──────────────────────────────────────────────────┐
│           vdg_eminj_8msm() 調停処理              │
│                                                  │
│  ┌────────────────────────────────────┐          │
│  │   要求データバッファ                │          │
│  │   sts_eminj_*_data[複数]            │          │
│  └────────────────────────────────────┘          │
│                  │                               │
│                  ▼                               │
│  ┌────────────────────────────────────┐          │
│  │    優先度テーブル                  │          │
│  │    sts_eminj_eminj_tbl[]           │          │
│  │    sts_eminj_eminjlmt_tbl[]        │          │
│  └────────────────────────────────────┘          │
│                  │                               │
│                  ▼                               │
│  ┌────────────────────────────────────┐          │
│  │    調停処理                        │          │
│  │    vds_eminj_eminj_hpri()          │          │
│  │    vds_eminj_eminjlmt_hpri()       │          │
│  └────────────────────────────────────┘          │
│                  │                               │
│                  ▼                               │
│  ┌────────────────────────────────────┐          │
│  │    選択結果 + 補正係数適用         │          │
│  └────────────────────────────────────┘          │
└──────────────────────────────────────────────────┘
                       │
                       │ vds_eminj_*_dataset()
                       ▼
┌──────────────────────────────────────────────────┐
│          グローバルデータ構造                     │
│                                                  │
│  ┌────────────────────────────────────┐          │
│  │  stg_eminj_einj  (旧構造)         │          │
│  │  - s2_qinjall[NCYL][NOX]          │          │
│  │  - s2_ainjall[NCYL][NOX]          │          │
│  │  - s2_krchref[NOX]                │          │
│  │  - その他パラメータ...            │          │
│  └────────────────────────────────────┘          │
│                                                  │
│  ┌────────────────────────────────────┐          │
│  │  stg_eminj_eminj  (新構造)        │          │
│  │  - s2_qinjall[NCYL][NOX][段]      │          │
│  │  - s2_ainjall[NCYL][NOX][段]      │          │
│  │  - s2_krchref[NOX]                │          │
│  │  - 拡張パラメータ...              │          │
│  └────────────────────────────────────┘          │
└──────────────────────────────────────────────────┘
                       │
                       │ vdg_eminj_*_dataget()
                       ▼
┌──────────────────────────────────────────────────┐
│               外部参照モジュール                  │
│  ・噴射制御モジュール                            │
│  ・燃圧制御モジュール                            │
│  ・診断モジュール                                │
│  ・その他...                                     │
└──────────────────────────────────────────────────┘
```

## タイミングチャート

```
時刻軸 →

pwon
  │
  ├── vdg_eminj_pwon()
  │     └── 初期化完了
  │
  ▼
8msm周期
  │
  ├── vdg_eminj_8msm()  ← 8ms周期で実行
  │     │
  │     ├── 要求データ取得
  │     ├── 優先度調停
  │     ├── パラメータ決定
  │     └── データ更新
  │
  ├── 8ms後
  │
  ├── vdg_eminj_8msm()  ← 再度実行
  │     │
  │     └── ...
  │
  ▼
要求時
  │
  ├── vdg_eminj_einj_dataget()  ← 必要時に呼び出し
  │     └── データ提供
  │
  ├── vdg_eminj_eminj_dataget() ← 必要時に呼び出し
  │     └── データ提供(新構造)
  │
  ▼
```

## 条件分岐の主要パターン

```
1. 噴射方式による分岐 (JEEFI)
   ┌─────────────────┐
   │     JEEFI?      │
   └─────────────────┘
      │       │       │
   PORT    DUAL      D4
      │       │       │
   ポート  ポート+  直噴
   噴射    直噴      専用

2. 可変燃圧による分岐 (JEPRDEMAND)
   ┌─────────────────┐
   │  JEPRDEMAND?    │
   └─────────────────┘
      │           │
    USE       NOT_USE
      │           │
   可変燃圧   固定燃圧
   制御あり   制御なし

3. ハイブリッド仕様による分岐 (JEALLHV_E)
   ┌─────────────────┐
   │  JEALLHV_E?     │
   └─────────────────┘
      │           │
   ALLHV_E    それ以外
      │           │
   HV専用     通常処理
   処理追加

4. 排気状態による分岐
   ┌─────────────────┐
   │   u1t_xast?     │
   └─────────────────┘
      │           │
     ON          OFF
      │           │
   始動後      始動中
   処理        処理
```

## まとめ

このフロー図は、l_mat.cモジュールの主要な処理の流れを示しています。

- **初期化**: システム起動時に1回実行
- **調停処理**: 8ms周期で定期的に実行
- **データ取得**: 外部モジュールからの要求に応じて実行

各処理は明確な責任を持ち、優先度テーブルに基づいた調停により、
複数の機能からの噴射要求を適切に管理しています。
